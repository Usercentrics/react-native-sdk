name: CI/CD

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs: 
  test-rn:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - name: Use Node.js "14.x"
        uses: actions/setup-node@v1
        with:
          node-version: "14.x"

      - name: Run RN Tests
        run: |
          npm ci
          npm test

  test-ios: 
    needs: test-rn
    runs-on: macos-latest
    defaults:
      run:
        working-directory: example

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      
    - name: Setup Node
      uses: actions/setup-node@v2
      with:
        node-version: "14.x"

    - name: Install NPM dependencies
      run: npm install

    - name: Install pods
      run: cd ios && pod install

    - name: Run tests
      run:  cd ios && xcodebuild -workspace example.xcworkspace -scheme "example" -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 12' test

  test-android: 
    needs: test-rn
    runs-on: macOS-latest

    steps: 
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Node
      uses: actions/setup-node@v2
      with:
        node-version: "14.x"

    - name: Java 11
      uses: actions/setup-java@v1
      with:
        java-version: 11

    - name: Install Dependencies
      working-directory: ./example
      run: ../scripts/install_dependencies.sh

    - name: Android tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
          working-directory: ./example/android
          api-level: 29
          script: gradle wrapper; ./gradlew :react-native-usercentrics:connectedAndroidTest

  build-ios-android:
    needs: [test-rn, test-android, test-ios]
    runs-on: macOS-latest

    steps: 
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Node
      uses: actions/setup-node@v2
      with:
        node-version: "14.x"

    - name: Java 11
      uses: actions/setup-java@v1
      with:
        java-version: 11

    - name: Install Dependencies
      working-directory: ./example
      run: ../scripts/install_dependencies.sh

    - name: Build Android
      uses: reactivecircus/android-emulator-runner@v2
      with:
          working-directory: ./example/android
          api-level: 29
          script: gradle wrapper; cd .. && npx react-native run-android

    - name: Build iOS
      working-directory: ./example/ios
      run: pod install; cd .. && npx react-native run-ios
