name: CI/CD

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  test-rn:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - name: Use Node.js "14.x"
        uses: actions/setup-node@v1
        with:
          node-version: "14.x"

      - name: Run RN Tests
        run: |
          npm ci
          npm test

  test-ios:
    needs: test-rn
    runs-on: macos-11
    defaults:
      run:
        working-directory: example

    steps:
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '13.0'

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Node
      uses: actions/setup-node@v2
      with:
        node-version: "14.x"

    - name: Install NPM dependencies
      run: npm install

    - name: Install pods
      run: cd ios && pod install

    - name: Run tests
      run:  cd ios && xcodebuild -workspace example.xcworkspace -scheme "example" -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 12' test

  test-android:
    needs: test-rn
    runs-on: macOS-latest
    env:
      GRADLE_VERSION: 7.6

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Node
      uses: actions/setup-node@v2
      with:
        node-version: "14.x"

    - name: Java 11
      uses: actions/setup-java@v1
      with:
        java-version: 11

    - name: Install Dependencies npm
      working-directory: ./example
      run: npm install

    - name: Cache Gradle
      id: cache-gradle
      uses: actions/cache@v2
      with:
        path: |
          ./example/android/ci-cache/gradle
          ./example/android/gradle/wrapper/gradle-wrapper.jar
          ./example/android/gradlew
        key: ${{ runner.os }}-cache-gradle-${{ env.GRADLE_VERSION }}

    - name: Android tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
          working-directory: ./example/android
          api-level: 29
          script: gradle wrapper; ./gradlew :react-native-usercentrics:connectedAndroidTest
